<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lofi Kick — Tone.js (single component)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0b1220; color:#e6eef8; display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;}
    .card{width:420px;padding:20px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    h1{margin:0 0 8px 0;font-size:18px;}
    .row{display:flex;gap:10px;align-items:center;margin-top:10px;}
    label{font-size:13px;color:#a9c0da;min-width:90px;}
    input[type=range]{width:100%;}
    button{background:#1f2937;color:#e6eef8;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;}
    .small{font-size:12px;color:#9fb6d6;margin-top:8px;}
    .status{font-size:13px;color:#9fb6d6;margin-top:10px;}
  </style>
</head>
<body>
  <div class="card">
    <h1>Lofi Kick — single component (Tone.js)</h1>

    <div class="row">
      <button id="startBtn">Start (required)</button>
      <button id="playBtn" disabled>Play Kick</button>
      <button id="stopLoopBtn" disabled>Stop Loop</button>
    </div>

    <div class="row">
      <label for="loopToggle">Loop</label>
      <input id="loopToggle" type="checkbox" />
      <label style="min-width:70px;margin-left:6px;">BPM</label>
      <input id="bpm" type="range" min="40" max="140" value="75">
      <div id="bpmVal">75</div>
    </div>

    <div class="row">
      <label for="pitch">Start pitch (Hz)</label>
      <input id="pitch" type="range" min="40" max="200" value="120">
      <div id="pitchVal">120 Hz</div>
    </div>

    <div class="row">
      <label for="pitchDecay">Pitch glide (ms)</label>
      <input id="pitchDecay" type="range" min="30" max="500" value="120">
      <div id="pdecVal">120 ms</div>
    </div>

    <div class="row">
      <label for="decay">Amp decay (s)</label>
      <input id="decay" type="range" min="0.05" max="1.5" step="0.01" value="0.32">
      <div id="decVal">0.32 s</div>
    </div>

    <div class="row">
      <label for="vol">Volume (dB)</label>
      <input id="vol" type="range" min="-36" max="0" value="-10">
      <div id="volVal">-10 dB</div>
    </div>

    <div class="status" id="status">Status: <strong id="st">idle</strong></div>
    <div class="small">Open DevTools → Console for debug logs. If you hear nothing, make sure the page is served via HTTPS or GitHub Pages and that you pressed Start.</div>
  </div>

  <!-- Tone.js (stable 14 release) -->
  <script src="https://unpkg.com/tone@14.7.77/build/Tone.min.js"></script>
  <script>
    (function(){
      // UI
      const startBtn = document.getElementById('startBtn');
      const playBtn = document.getElementById('playBtn');
      const stopLoopBtn = document.getElementById('stopLoopBtn');
      const loopToggle = document.getElementById('loopToggle');
      const bpmSlider = document.getElementById('bpm');
      const bpmVal = document.getElementById('bpmVal');
      const pitchSlider = document.getElementById('pitch');
      const pitchVal = document.getElementById('pitchVal');
      const pitchDecaySlider = document.getElementById('pitchDecay');
      const pdecVal = document.getElementById('pdecVal');
      const decaySlider = document.getElementById('decay');
      const decVal = document.getElementById('decVal');
      const volSlider = document.getElementById('vol');
      const volVal = document.getElementById('volVal');
      const statusEl = document.getElementById('st');

      function dbg(...args){ console.log('[KICK]', ...args); }

      // Master volume -> destination
      const masterVol = new Tone.Volume(parseFloat(volSlider.value)).toDestination();

      // We'll build a kick from a short sine pitch sweep + amplitude envelope (classic synthesized kick).
      // Using a small custom synth so we can precisely control pitch glide and decay.
      function createKickSynth(){
        // Gain node for the synth
        const gain = new Tone.Gain(0.9).connect(masterVol);

        // Oscillator (sine) used for body + pitch sweep
        const osc = new Tone.Oscillator(120, 'sine').start();

        // A short noise burst for transient "click" (optional, subtle)
        const clickNoise = new Tone.Noise('white');
        const clickFilter = new Tone.Filter(5000, 'highpass');
        const clickGain = new Tone.Gain(0).connect(gain); // start muted
        clickNoise.connect(clickFilter).connect(clickGain);
        clickNoise.start();

        // Connect osc to gain
        osc.connect(gain);

        // We'll control frequency and amplitude with Envelopes when triggering
        return {
          osc,
          gain,
          trigger: (time, opts={}) => {
            // opts: startFreq (Hz), endFreq (Hz), pitchDecayMs, ampDecay (s), velocity 0..1
            const now = time || Tone.now();
            const startFreq = opts.startFreq ?? 120;
            const endFreq = opts.endFreq ?? 40;
            const pitchDecay = (opts.pitchDecayMs ?? 120) / 1000; // to seconds
            const ampDecay = opts.ampDecay ?? 0.32;
            const velocity = opts.velocity ?? 1.0;

            // Frequency envelope: set immediate, then linear ramp to endFreq
            this.osc.frequency.cancelScheduledValues(now);
            this.osc.frequency.setValueAtTime(startFreq, now);
            this.osc.frequency.exponentialRampToValueAtTime(Math.max(endFreq, 10), now + pitchDecay);

            // Amplitude envelope: simple exponential ramp down
            this.gain.gain.cancelScheduledValues(now);
            this.gain.gain.setValueAtTime(velocity, now);
            this.gain.gain.exponentialRampToValueAtTime(0.0001, now + ampDecay);

            // short click: gate noise briefly
            clickGain.gain.cancelScheduledValues(now);
            clickGain.gain.setValueAtTime(0.6 * velocity, now);
            clickGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.012);
          }
        };
      }

      // instantiate kick synth
      const kick = createKickSynth();

      // Loop (simple quarter-note pattern; you can change)
      Tone.Transport.bpm.value = parseInt(bpmSlider.value, 10);
      let loop = null;
      let isLooping = false;
      const pattern = [1,0,0,0]; // 4/4 kick on beats 1 only (you can change to [1,0,0,1] etc)

      function startLoop(){
        if (isLooping) return;
        let idx = 0;
        loop = new Tone.Loop((time) => {
          if (pattern[idx % pattern.length]) {
            kick.trigger(time, {
              startFreq: parseFloat(pitchSlider.value),
              endFreq: 40,
              pitchDecayMs: parseFloat(pitchDecaySlider.value),
              ampDecay: parseFloat(decaySlider.value),
              velocity: 1.0
            });
            dbg('loop kick at', time.toFixed(3), 'idx', idx % pattern.length);
          }
          idx++;
        }, "4n").start(0);
        Tone.Transport.start();
        isLooping = true;
        statusEl.textContent = 'looping';
        stopLoopBtn.disabled = false;
        playBtn.disabled = true;
        loopToggle.checked = true;
      }

      function stopLoop(){
        if (!isLooping) return;
        if (loop) loop.stop();
        Tone.Transport.stop();
        isLooping = false;
        statusEl.textContent = 'idle';
        stopLoopBtn.disabled = true;
        playBtn.disabled = false;
        loopToggle.checked = false;
      }

      // UI behaviour
      startBtn.addEventListener('click', async () => {
        try {
          dbg('Start pressed; calling Tone.start()');
          await Tone.start(); // required gesture
          dbg('AudioContext state:', Tone.context.state);
          statusEl.textContent = Tone.context.state;
          startBtn.disabled = true;
          playBtn.disabled = false;
        } catch(e){
          console.error('Tone.start error', e);
          statusEl.textContent = 'error (check console)';
        }
      });

      playBtn.addEventListener('click', () => {
        // trigger single kick immediately
        kick.trigger(Tone.now(), {
          startFreq: parseFloat(pitchSlider.value),
          endFreq: 40,
          pitchDecayMs: parseFloat(pitchDecaySlider.value),
          ampDecay: parseFloat(decaySlider.value),
          velocity: 1.0
        });
        dbg('played single kick');
      });

      stopLoopBtn.addEventListener('click', stopLoop);

      loopToggle.addEventListener('change', (e) => {
        if (e.target.checked) startLoop(); else stopLoop();
      });

      bpmSlider.addEventListener('input', () => {
        const b = parseInt(bpmSlider.value, 10);
        Tone.Transport.bpm.rampTo(b, 0.05);
        bpmVal.textContent = b;
      });

      pitchSlider.addEventListener('input', () => {
        pitchVal.textContent = pitchSlider.value + ' Hz';
      });
      pitchDecaySlider.addEventListener('input', () => {
        pdecVal.textContent = pitchDecaySlider.value + ' ms';
      });
      decaySlider.addEventListener('input', () => {
        decVal.textContent = parseFloat(decaySlider.value).toFixed(2) + ' s';
      });
      volSlider.addEventListener('input', () => {
        const db = parseFloat(volSlider.value);
        masterVol.volume.value = db;
        volVal.textContent = db + ' dB';
      });

      // initial UI values
      pitchVal.textContent = pitchSlider.value + ' Hz';
      pdecVal.textContent = pitchDecaySlider.value + ' ms';
      decVal.textContent = parseFloat(decaySlider.value).toFixed(2) + ' s';
      volVal.textContent = volSlider.value + ' dB';
      bpmVal.textContent = bpmSlider.value;

      // Helpful console hints
      dbg('Page ready. Tone.context.state =', Tone.context.state);
      dbg('If you hear nothing: make sure you clicked Start, check browser console for errors, ensure page served via HTTPS (GitHub Pages default).');

      // Clean up on page hide
      window.addEventListener('pagehide', () => {
        try { Tone.Transport.stop(); Tone.context.close(); } catch(e){}
      });
    })();
  </script>
</body>
</html>
